{% extends 'base.html' %} {% block content %}

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Lista de Proformas</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    />
    <style>
      .container-proformas-kike {
        width: 80%;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-top: 50px;
        position: relative;
      }
      .title-with-icon {
        font-size: 18px;
        color: orange;
        font-size: 16px;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .title-with-icon i {
        margin-right: 10px;
        font-size: 2em;
      }
      .title-with-icon h1 {
        margin: 0;
        font-size: 2em;
      }
      .search-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        position: relative;
      }
      .search-container input {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-right: 10px;
      }
      .search-container .search-button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
      }

      .header,
      .form-group,
      .line-details,
      .buttons,
      .totals {
        margin: 20px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input[type="text"],
      select {
        margin-top: 15px;
        width: 40%;
        padding: 8px;
        margin-bottom: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #95defd;
      }

      tbody tr:hover {
        background-color: hsl(180, 1%, 83%);
        transition: background-color 0.3s;
      }

      tbody td:hover {
        background-color: #efc737;
        transition: background-color 0.3s;
      }

      td input[type="number"] {
        width: 60px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        text-align: center;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      td input[type="number"]:focus {
        border-color: #007BFF;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      .save-proforma,
      .create-proforma {
        padding: 10px 20px;
        background-color: #3163f9;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
      }

      .modal-proforma {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .action-icons i {
        background-color: #96c4f5;
        color: red;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
      }
      .fixed-icons {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
      }
      .fixed-icons button {
        background-color: #ffffff;
        border: 1px solid #ddd;
        color: #3163f9;
        padding: 8px;
        border-radius: 50%;
        margin-bottom: 10px;
        cursor: pointer;
        font-size: 1.5em;
      }
      .create-proforma {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #4caf50;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border-radius: 50%;
        font-size: 24px;
        color: white;
        width: 50px;
        height: 50px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      @media (min-width: 1200px) {
        .h1, h1 {
          margin: auto;
          color: #1b9f8e;
          font-size: 2.5rem;
        }
      }

      .search-bar {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .search-label {
        margin-bottom: 5px;
        font-weight: bold;
      }

      .search-input-wrapper {
        display: flex;
        align-items: center;
      }

      .search-input-wrapper input[type="text"] {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        flex-grow: 1;
        margin-right: 10px;
      }

      .search-input-wrapper button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .icono-proforma-formulario {
        margin-right: 10px;
        color: #826119e7;
      }

      .moneda-unica {
        background-color: #e0f7fa;
        border: 2px solid #00796b;
        color: #004d40;
        padding: 5px;
        font-family: Arial, sans-serif;
        border-radius: 5px;
        width: 150px;
        cursor: pointer;
      }

      .moneda-unica:focus {
        border-color: #004d40;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 77, 64, 0.5);
      }

      .action-icons {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
      }

      .action-icons i {
        cursor: pointer;
        font-size: 20px;
        color: #555;
        transition: color 0.3s ease;
      }

      .action-icons i:hover {
        color: #007bff;
      }

      .action-icons i:active {
        transform: scale(0.95);
      }

      .buttons {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
      }

      .imprimir-proforma {
        font-size: 35px;
        color: #28a745;
        cursor: pointer;
        padding: 20px;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .image-below-proforma {
        text-align: center;
        margin-top: 15px;
      }

      .image-below-icon {
        border-radius: 35px;
        width: 300px;
        height: auto;
      }

      button[onclick="mostrarModalProductos()"] {
        background-color: #007BFF;
        color: #fff;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      button[onclick="mostrarModalProductos()"]:hover {
        background-color: #0056b3;
        transform: scale(1.05);
      }

      button[onclick="mostrarModalProductos()"]:active {
        background-color: #003d80;
        transform: scale(0.95);
      }

      #product-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        font-family: Arial, sans-serif;
      }

      #product-modal h3 {
        margin: 0;
        margin-bottom: 20px;
        font-size: 20px;
        color: #007BFF;
        text-align: center;
      }

      #product-modal select {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      #product-modal button {
        background-color: #28a745;
        color: #fff;
        padding: 10px 20px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      #product-modal button:hover {
        background-color: #218838;
        transform: scale(1.05);
      }

      #product-modal button:active {
        background-color: #1e7e34;
        transform: scale(0.95);
      }

      #product-modal button[onclick="cerrarModalProductos()"] {
        background-color: #dc3545;
      }

      #product-modal button[onclick="cerrarModalProductos()"]:hover {
        background-color: #c82333;
      }

      .totals {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
        font-family: Arial, sans-serif;
      }

      .totals h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
        color: #333;
      }

      .total-item {
        margin-bottom: 15px;
        font-size: 18px;
        color: #555;
      }

      .total-item strong {
        display: block;
        margin-bottom: 5px;
        font-size: 16px;
        color: #333;
      }

      .total-item p {
        font-size: 20px;
        color: #007BFF;
        margin: 0;
        font-weight: bold;
        text-align: left;
      }

      #info-subtotal {
        font-size: 15px;
        color: #D9534F;
        background-color: #F8D7DA;
        border: 1px solid #F5C6CB;
        padding: 10px;
        border-radius: 5px;
        margin: 20px 0;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      td select[name="unidad"] {
        width: 180px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        background-color: #f9f9f9;
        color: #333;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      td select[name="unidad"]:focus {
        border-color: #007BFF;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        background-color: #fff;
      }

      td select[name="unidad"] option {
        font-size: 14px;
        color: #555;
      }

      .icono-caja-abierta {
        font-size: 36px;
        color: #865a27e7;
        margin-right: 10px;
        vertical-align: middle;
      }

      .pagination-5lines {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 100px;
      }

      .pagination-5lines button {
        background-color: #3163f9;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .pagination-5lines button:hover:not(:disabled) {
        background-color: #1b9f8e;
      }

      .pagination-5lines button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .sin-datos {
        text-align: center;
        font-size: 18px;
        color: #888;
        font-style: italic;
      }

    </style>
  </head>
  <body>
    <div class="container-proformas-kike">
      <div class="title-with-icon">
        <i class="fa fa-file-invoice-dollar"></i>
        <h1>Proformas</h1>
      </div>
      <div class="search-container">
        <input type="text" id="search" placeholder="Buscar por cliente" />
      </div>
    </div>

    <div class="proforma-list" style="width: 100%; margin: 20px auto;">
      <table class="proforma-tabla">
          <thead>
              <tr>
                  <th>Fecha</th>
                  <th>Moneda</th>
                  <th>Cliente</th>
                  <th>Código Actividad Económica</th>
                  <th>Medio de Pago</th>
                  <th>Condición de Venta</th>
                  <th>Detalles</th>
                  <th>Nota</th>
                  <th>Total</th>
                  <th>Opciones</th>
              </tr>
          </thead>
          <tbody>
            {% for proforma in proformas %}
            <tr id="proforma-{{ proforma.id }}" 
                data-fecha="{{ proforma.fecha }}" 
                data-moneda="{{ proforma.moneda }}" 
                data-cliente="{{ proforma.cliente }}" 
                data-codigo="{{ proforma.codigo_actividad_economica }}" 
                data-medio_pago="{{ proforma.medio_pago }}" 
                data-condicion_venta="{{ proforma.condicion_venta }}" 
                data-detalles="{{ proforma.detalles }}" 
                data-nota="{{ proforma.nota }}" 
                data-total="{{ proforma.total }}">

                <td>{{ proforma.fecha }}</td>
                <td>{{ proforma.moneda }}</td>
                <td>{{ proforma.cliente }}</td>
                <td>{{ proforma.codigo_actividad_economica }}</td>
                <td>{{ proforma.medio_pago }}</td>
                <td>{{ proforma.condicion_venta }}</td>
                <td>{{ proforma.detalles }}</td>
                <td>{{ proforma.nota }}</td>
                <td>{{ proforma.total }}</td>
                <td class="action-icons">
                    <form action="{% url 'eliminar_proforma' proforma.pk %}" method="POST" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                    <i class="fas fa-edit" onclick="editarProforma({{ proforma.id }})"></i>
                </td>
            </tr>
            {% empty %}
            <tr class="fila-vacia">
                <td colspan="10" class="text-center">No hay proformas registrados</td>
            </tr>
            {% endfor %}
          </tbody>
      </table>
    </div>

    <!-- Contenedor de paginación -->
    <div class="pagination-5lines">
      <button onclick="prevPage()" id="prevPageBtn">Anterior</button>
      <span>Página <span id="paginaActual">1</span> de <span id="totalPaginas">1</span></span>
      <button onclick="nextPage()" id="nextPageBtn">Siguiente</button>
    </div>

    <button class="create-proforma" onclick="openModal()">+</button>

    <!-- Modal de Crear Proforma -->
    <div id="proformaModal" class="modal-proforma" style="display: none;">
      <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <h1><i class="fas fa-file-invoice icono-proforma-formulario"></i>Formulario Proforma</h1>
          <form action="{% url 'crear_proforma' %}" method="POST">
              {% csrf_token %}

              <div class="header">
                  <div class="header-left">
                      <label for="fecha">Fecha:</label>
                      <input type="date" class="form-control" id="fecha" name="fecha">

                      <label for="moneda">Moneda:</label>
                      <select id="moneda" name="moneda" class="moneda-unica">
                          <option value="CRC">Colones</option>
                          <option value="USD">Dólares</option>
                      </select>
                  </div>
                  <div class="header-right">
                      <p>Ferreteria San jeronimo S.A, Moravia Telefono: 2224 4585</p>
                      <p>Venta al por menor artículos de ferretería, pinturas, madera y materiales para la construcción.</p>
                      <p>Este documento no es válido como factura ni documento fiscal.</p>
                  </div>
              </div>

              <div class="form-group">
                  <label for="cliente">Cliente:</label>
                  <input type="text" id="cliente" name="cliente" placeholder="Busca por nombre, cédula o teléfono">
              </div>

              <div class="form-group">
                  <label for="codigo_actividad_economica">Código de Actividad Económica:</label>
                  <select id="codigo_actividad_economica" name="codigo_actividad_economica">
                      <option value="regular">Regular</option>
                      <option value="especial">Especial</option>
                      <option value="exento">Exento</option>
                  </select>
              </div>

              <div class="form-group">
                  <label for="medio_pago">Medio de pago:</label>
                  <select id="medio_pago" name="medio_pago">
                      <option value="efectivo">Efectivo</option>
                      <option value="tarjeta">Tarjeta</option>
                      <option value="transferencia">Transferencia</option>
                      <option value="cheque">Cheque</option>
                      <option value="deposito">Depósito</option>
                      <option value="otros">Otros</option>
                  </select>

                  <label for="condicion_venta">Condición de venta:</label>
                  <select id="condicion_venta" name="condicion_venta">
                      <option value="contado">Contado</option>
                      <option value="credito">Crédito</option>
                  </select>
              </div>

              <div class="form-group">
                  <label for="detalles">Detalles:</label>
                  <input type="text" id="detalles" name="detalles" placeholder="Detalles de la proforma">
              </div>
              <div class="form-group">
                  <label for="nota">Nota:</label>
                  <input type="text" id="nota" name="nota" placeholder="Nota adicional">
              </div>

              <div class="line-details">
                  <h2>Detalles de línea</h2>
                  <h1 id="info-subtotal">
                    ¡Importante: El Subtotal, IVA y Total Neto se calculan automáticamente una vez
                    colocado el descuento en 1 o más, en los productos de la tabla!
                  </h1>
                  <table id="line-items-table">
                      <thead>
                          <tr>
                              <th>Código</th>
                              <th>nombre</th>
                              <th>Descripción</th>
                              <th>Cantidad</th>
                              <th>Unidad</th>
                              <th>Precio Unitario</th>
                              <th>Descuento %</th>
                              <th>Descuento aplicado</th>
                              <th>Total</th>
                              <th>Opciones</th>
                          </tr>
                      </thead>
                      <tbody>
                          <!-- Aquí se llenarán las filas dinámicamente -->
                      </tbody>
                  </table>
              </div>

              <button type="button" onclick="mostrarModalProductos()">Agregar Producto</button>

              <!-- Modal de Selección de Productos -->
              <div id="product-modal" style="display: none;">
                  <h3><i class="fas fa-box-open icono-caja-abierta"></i> Seleccionar Producto</h3>
                  <select id="product-select">
                      <!-- Opciones llenadas dinámicamente -->
                  </select>
                  <button type="button" onclick="agregarProducto()">Agregar Producto</button>
                  <button type="button" onclick="cerrarModalProductos()">Cerrar</button>
              </div>

              <div class="totals">
                <div class="total-item">
                    <strong>Descuento aplicado :</strong>
                    <p id="descuento">₡0.00</p>
                </div>
                <div class="total-item">
                    <strong>Subtotal:</strong>
                    <p id="subtotal">₡0.00</p>
                </div>
                <div class="total-item">
                    <strong>IVA:</strong>
                    <p id="iva">₡0.00</p>
                </div>
                <div class="total-item">
                    <strong>Total Neto:</strong>
                    <p id="total">₡0.00</p>
                    <strong>Total Neto en Dólares:</strong>
                    <p id="total-dolares" style="color: #007BFF; font-size: 20px;">$0.00</p>
                    <p id="tipo-cambio" style="color: #6c757d; font-size: 18px;">Tipo de cambio utilizado: ₡550.00 por $1</p>
                    <p>Este tipo de Cambio está sujeto al cambio actual en el Banco Central de Costa Rica</p>
                </div>
              </div>

              <input type="hidden" id="subtotal-input" name="subtotal">
              <input type="hidden" id="descuento-input" name="descuento">
              <input type="hidden" id="iva-input" name="iva">
              <input type="hidden" id="total-input" name="total">
              <input type="hidden" id="total-dolares-input" name="total_dolares">

              <div class="buttons">
                <button type="submit" class="save-proforma" onclick="prepararDatosProforma()">Guardar</button>
              </div>
          </form>
          <div class="buttons-imprimir-proforma">
            <i class="fas fa-print imprimir-proforma" onclick="imprimirProforma()"></i>
          </div>
          <div class="image-below-proforma">
            {% load static %}
            <img src="{% static 'img/logo.jpg' %}" alt="Question Image" class="image-below-icon"/>
          </div>
      </div>
    </div>

    <div id="editarproformaModal" class="modal-proforma" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h1><i class="fas fa-file-invoice icono-proforma-formulario"></i> Editar Proforma</h1>
        <form action="{% url 'editar_proforma' %}" method="POST">
          {% csrf_token %}
          <div class="header">
            <div class="header-left">
              <input type="date" class="form-control" id="editarfecha" name="fecha">
              <select id="editarmoneda" name="moneda" class="moneda-unica">
                <option value="CRC">CRC</option>
                <option value="USD">Dólares</option>
              </select>
            </div>
            <div class="header-right">
              <p>
                Venta al por menor artículos de ferretería,
                pinturas, madera y materiales para la construcción.
              </p>
              <p>Este documento no es válido como factura ni documento fiscal</p>
            </div>
          </div>
          <label for="editarcliente">Cliente:</label>
          <input
            type="text"
            id="editarcliente"
            name="cliente"
            placeholder="Busca por nombre, cédula o teléfono"
          /> 

          <div class="form-group">
            <label for="editarcodigoactividadeconomica">Código-actividad-económica:</label>
            <select id="editarcodigoactividadeconomica" name="codigo_actividad_economica">
              <option value="regular">Regular</option>
              <option value="especial">Especial</option>
              <option value="exento">Mayorista</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editarmediopago">Medio de pago:</label>
            <select id="editarmediopago" name="medio_pago">
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="transferencia">Transferencia</option>  
              <option value="cheque">Cheque</option>
              <option value="deposito">Depósito</option>
              <option value="otros">Otros</option>
            </select>
            <label for="editarcondicionventa">Condición de venta:</label>
            <select id="editarcondicionventa" name="condicion_venta">
              <option value="contado">Contado</option>
              <option value="credito">Crédito</option>
            </select>
          </div>

          <div class="form-group">
              <label for="editardetalles">Detalles:</label>
              <input type="text" id="editardetalles" name="detalles" placeholder="Detalles de la proforma" />
          </div>
          <div class="form-group">
              <label for="editarnota">Nota:</label>
              <input type="text" id="editarnota" name="nota" placeholder="Nota adicional" />
          </div>

          <div class="search-bar">
            <label for="nota" class="search-label">Producto:</label>
            <div class="search-input-wrapper">
                <input type="text" id="nota" placeholder="Ingrese el nombre del producto">
                <button><i class="fa fa-search"></i></button>
            </div>
          </div>

          <div class="line-details">
            <h2>Desglose de la Proforma</h2>
            <h1 id="info-subtotal">
              ¡Importante: El Subtotal, IVA y Total Neto se calculan automáticamente una vez
              colocado el descuento en 1 o más!
            </h1>
            <table id="line-items-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Unidad</th>
                        <th>Precio Unitario</th>
                        <th>Descuento</th>
                        <th>IVA</th>
                        <th>Total</th>
                        <th>Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se llenarán las filas dinámicamente -->
                </tbody>
            </table>
          </div>

          <!-- Eliminado el segundo modal de productos aquí para evitar duplicados -->

          <div class="totals">
            <div class="total-item">
                <strong>Descuento aplicado :</strong>
                <p id="descuento">₡0.00</p>
            </div>
            <div class="total-item">
                <strong>Subtotal:</strong>
                <p id="subtotal">₡0.00</p>
            </div>
            <div class="total-item">
                <strong>IVA:</strong>
                <p id="iva">₡0.00</p>
            </div>
            <div class="total-item">
                <strong>Total Neto:</strong>
                <p id="total">₡0.00</p>
                <strong>Total Dolares</strong>
                <p id="total-dolares" style="color: #007BFF; font-size: 18px;">$0.00</p>
                <p id="tipo-cambio" style="color: #6c757d; font-size: 18px;">Tipo de cambio utilizado: ₡550.00 por $1</p>
            </div>
          </div>
        
          <input type="hidden" id="subtotal-input" name="subtotal">
          <input type="hidden" id="descuento-input" name="descuento">
          <input type="hidden" id="iva-input" name="iva">
          <input type="hidden" id="total-input" name="total">
          <input type="hidden" id="total-dolares-input" name="total_dolares">
      
          <div class="buttons">
              <button type="submit" class="save-proforma" onclick="prepararDatosProforma()">Guardar</button>
          </div>
        </form>
        <div class="buttons-imprimir-proforma">
          <i class="fas fa-print imprimir-proforma" onclick="imprimirProforma()"></i>
        </div>
        <div class="image-below-proforma">
          {% load static %}
          <img src="{% static 'img/logo.jpg' %}" alt="Question Image" class="image-below-icon"/>
        </div>
      </div>
    </div>


    <script>
      function imprimirProforma() {
        var contenido = document.getElementById('proformaModal').cloneNode(true);

        var infoSubtotal = contenido.querySelector('#info-subtotal');
        if (infoSubtotal) {
            infoSubtotal.remove();
        }

        var botonAgregarProducto = contenido.querySelector('button[onclick="mostrarModalProductos()"]');
        if (botonAgregarProducto) {
            botonAgregarProducto.remove();
        }

        var ventanaImpresion = window.open('', '', 'height=900,width=800');
        ventanaImpresion.document.write('<html><head><title>Proforma</title>');
        ventanaImpresion.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">');
        ventanaImpresion.document.write('<style>');
        ventanaImpresion.document.write(`
          @media print {
              body {
                  font-family: Arial, sans-serif;
                  font-size: 20px;
                  margin: 0;
                  padding: 40px;
              }
              .modal-content {
                  width: 100%;
                  margin: 0;
                  padding: 20px;
              }
              h1, h2 {
                  text-align: center;
                  font-size: 24px;
              }
              table {
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 18px;
              }
              th, td {
                  padding: 12px;
                  border: 1px solid black;
                  text-align: left;
              }
              th:last-child, td:last-child {
               display: none;
              }
              td input[type="number"] {
                  width: 60px;
                  padding: 5px;
                  border: 1px solid #ccc;
                  border-radius: 4px;
                  font-size: 14px;
                  text-align: center;
                  outline: none;
                  transition: border-color 0.3s ease, box-shadow 0.3s ease;
              }
              .header-right p {
                  text-align: right;
                  font-size: 18px;
              }
              .buttons, .buttons-imprimir-proforma, .close {
                  display: none;
              }
              .image-below-icon {
                  margin: 0 350px;
                  border-radius: 35px;
                  margin-top: 45px;
                  width: 250px;
              }
          }
        `);
        ventanaImpresion.document.write('</style></head><body>');
        ventanaImpresion.document.body.appendChild(contenido);
        ventanaImpresion.document.close();
        ventanaImpresion.onload = function() {
            ventanaImpresion.focus();
            ventanaImpresion.print();
            ventanaImpresion.close();
        };
      }

      function openModal() {
        document.getElementById("proformaModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("proformaModal").style.display = "none";
        document.getElementById("editarproformaModal").style.display = "none";
      }

      function editarProforma(id) {
        var row = document.getElementById("proforma-" + id);
        var fecha = row.getAttribute("data-fecha");
        var moneda = row.getAttribute("data-moneda");
        var cliente = row.getAttribute("data-cliente");
        var codigoActividad = row.getAttribute("data-codigo");
        var medioPago = row.getAttribute("data-medio_pago");
        var condicionVenta = row.getAttribute("data-condicion_venta");
        var detalles = row.getAttribute("data-detalles");
        var nota = row.getAttribute("data-nota");

        document.getElementById("editarfecha").value = fecha;
        document.getElementById("editarmoneda").value = moneda;
        document.getElementById("editarcliente").value = cliente;
        document.getElementById("editarcodigoactividadeconomica").value = codigoActividad;
        document.getElementById("editarmediopago").value = medioPago;
        document.getElementById("editarcondicionventa").value = condicionVenta;
        document.getElementById("editardetalles").value = detalles;
        document.getElementById("editarnota").value = nota;

        document.getElementById("editarproformaModal").style.display = "block";
      }

      function formatearColones(valor) {
        return `₡${parseFloat(valor).toFixed(2)}`;
      }

      function formatearDolares(valor) {
        return `$${parseFloat(valor).toFixed(2)}`;
      }

      function mostrarModalProductos() {
        fetch("{% url 'obtener_productos' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al obtener los productos");
                }
                return response.json();
            })
            .then(data => {
                const select = document.querySelector("#product-select");
                select.innerHTML = "";
                data.forEach(producto => {
                    const option = `
                        <option value="${producto.id}" 
                                data-codigo="${producto.codigo_cabys}" 
                                data-nombre="${producto.nombre}" 
                                data-descripcion="${producto.descripcion}" 
                                data-precio="${producto.precio_venta}">
                            ${producto.codigo_cabys} - ${producto.nombre} - ₡${producto.precio_venta}
                        </option>`;
                    select.insertAdjacentHTML("beforeend", option);
                });
                document.querySelector("#product-modal").style.display = "block";
            })
            .catch(error => console.error("Error al cargar productos:", error));
      }

      function agregarProducto() {
        const select = document.querySelector("#product-select");
        const selectedOption = select.options[select.selectedIndex];

        if (!selectedOption) {
            alert("Por favor, selecciona un producto.");
            return;
        }

        const codigo = selectedOption.getAttribute("data-codigo");
        const nombre = selectedOption.getAttribute("data-nombre");
        const descripcion = selectedOption.getAttribute("data-descripcion") || "Sin descripción";
        const precioVenta = parseFloat(selectedOption.getAttribute("data-precio"));

        const tbody = document.querySelector("#line-items-table tbody");
        const fila = `
            <tr>
                <td>${codigo}</td>
                <td>${nombre}</td>
                <td>${descripcion}</td>
                <td><input type="number" value="1" min="1" onchange="updateTotal(this)"></td>
                <td>
                    <select name="unidad">
                        <option value="Unidad">Unidad</option>
                        <option value="Kg">Kg</option>
                        <option value="Litros">Litros</option>
                        <option value="Tonelada">Tonelada</option>
                    </select>
                </td>
                <td>${formatearColones(precioVenta)}</td>
                <td><input type="number" value="0" min="0" max="100" onchange="updateTotal(this)"></td>
                <td class="descuento">₡0.00</td>
                <td>${formatearColones(precioVenta)}</td>
                <td class="action-icons">
                    <i class="fas fa-trash" onclick="eliminarFila(this)"></i>
                </td>
            </tr>`;
        tbody.insertAdjacentHTML("beforeend", fila);

        cerrarModalProductos();
        updateTotal();
      }

      function cerrarModalProductos() {
        document.querySelector("#product-modal").style.display = "none";
      }

      function eliminarFila(elemento) {
        elemento.closest("tr").remove();
        actualizarSubtotal();
      }

      function updateTotal(input = null) {
        const fila = input ? input.closest("tr") : null;
        const filas = fila ? [fila] : document.querySelectorAll("#line-items-table tbody tr");

        filas.forEach(fila => {
          const cantidad = parseFloat(fila.querySelector("td:nth-child(4) input").value) || 0;
          const precioUnitario = parseFloat(fila.querySelector("td:nth-child(6)").textContent.replace("₡", "")) || 0;
          const descuentoPorcentaje = parseFloat(fila.querySelector("td:nth-child(7) input").value) || 0;

          if (descuentoPorcentaje < 0 || descuentoPorcentaje > 100) {
              alert("El descuento debe estar entre 0% y 100%");
              fila.querySelector("td:nth-child(7) input").value = 0;
              return;
          }

          const subtotal = cantidad * precioUnitario;
          const descuento = (subtotal * descuentoPorcentaje) / 100;
          const total = subtotal - descuento;

          fila.querySelector("td:nth-child(8)").textContent = formatearColones(descuento);
          fila.querySelector("td:nth-child(9)").textContent = formatearColones(total);
        });

        actualizarSubtotal();
      }

      function actualizarSubtotal() {
        const filas = document.querySelectorAll("#line-items-table tbody tr");
        let subtotal = 0;
        let descuento = 0;

        filas.forEach(fila => {
            const total = parseFloat(fila.querySelector("td:nth-child(9)").textContent.replace("₡", "")) || 0;
            const descuentoFila = parseFloat(fila.querySelector("td:nth-child(8)").textContent.replace("₡", "")) || 0;
            subtotal += total;
            descuento += descuentoFila;
        });

        document.querySelector("#subtotal").textContent = formatearColones(subtotal);
        document.querySelector("#descuento").textContent = formatearColones(descuento);

        const iva = subtotal * 0.13;
        document.querySelector("#iva").textContent = formatearColones(iva);

        const totalNeto = subtotal + iva;
        document.querySelector("#total").textContent = formatearColones(totalNeto);

        const tasaCambio = 550;
        const totalDolares = totalNeto / tasaCambio;
        document.querySelector("#total-dolares").textContent = formatearDolares(totalDolares);
        document.querySelector("#tipo-cambio").textContent = `Tipo de cambio utilizado: ₡${tasaCambio.toFixed(2)} por $1`;
        document.querySelector("#total-dolares-input").value = totalDolares.toFixed(2);
      }

      function prepararDatosProforma() {
        const subtotal = parseFloat(document.querySelector("#subtotal").textContent.replace("₡", ""));
        const descuento = parseFloat(document.querySelector("#descuento").textContent.replace("₡", ""));
        const iva = parseFloat(document.querySelector("#iva").textContent.replace("₡", ""));
        const total = parseFloat(document.querySelector("#total").textContent.replace("₡", ""));
        const totalDolares = parseFloat(document.querySelector("#total-dolares-input").value);

        document.querySelector("#subtotal-input").value = subtotal;
        document.querySelector("#descuento-input").value = descuento;
        document.querySelector("#iva-input").value = iva;
        document.querySelector("#total-input").value = total;
        document.querySelector("#total-dolares-input").value = totalDolares;
      }

      function filterTable() {
        const query = document.getElementById('search').value.toLowerCase().trim();
        const tableBody = document.querySelector('.proforma-list table tbody');
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach(row => {
            if (row.classList.contains('fila-vacia')) {
                row.style.display = 'none';
                return;
            }

            const cliente = row.dataset.cliente.toLowerCase();
            const condicionVenta = row.dataset.condicion_venta.toLowerCase();
            const detalles = row.dataset.detalles.toLowerCase();
            const nota = row.dataset.nota.toLowerCase();
            const total = row.dataset.total.toLowerCase();

            if (
                cliente.includes(query) ||
                condicionVenta.includes(query) ||
                detalles.includes(query) ||
                nota.includes(query) ||
                total.includes(query)
            ) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        const anyVisible = Array.from(rows).some(row => !row.classList.contains('fila-vacia') && row.style.display !== 'none');
        const emptyRow = tableBody.querySelector('.fila-vacia');
        if (emptyRow) {
            emptyRow.style.display = anyVisible ? 'none' : '';
        }
      }

      document.getElementById('search').addEventListener('input', filterTable);

      const filasPorPagina = 5;
      let paginaActual = 1;
      const tabla = document.querySelector(".proforma-tabla").getElementsByTagName("tbody")[0];
      let filas = Array.from(tabla.getElementsByTagName("tr"));
      let totalPaginas = Math.ceil(filas.length / filasPorPagina);

      function mostrarPagina(pagina) {
        for (let i = 0; i < filas.length; i++) {
          filas[i].style.display = "none";
        }

        const inicio = (pagina - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        for (let i = inicio; i < fin && i < filas.length; i++) {
          filas[i].style.display = "";
        }

        document.getElementById("paginaActual").textContent = pagina;
        document.getElementById("totalPaginas").textContent = totalPaginas;

        document.getElementById("prevPageBtn").disabled = pagina === 1;
        document.getElementById("nextPageBtn").disabled = pagina === totalPaginas;
      }

      function nextPage() {
        if (paginaActual < totalPaginas) {
          paginaActual++;
          mostrarPagina(paginaActual);
        }
      }

      function prevPage() {
        if (paginaActual > 1) {
          paginaActual--;
          mostrarPagina(paginaActual);
        }
      }

      if (filas.length > 0) {
        mostrarPagina(paginaActual);
      } else {
        document.getElementById("totalPaginas").textContent = 1;
        document.querySelector(".pagination-5lines").style.display = "none";
      }

      // Unificar evento de cierre de modal al hacer clic fuera
      window.addEventListener('click', function(event) {
        var createModal = document.getElementById("proformaModal");
        var editModal = document.getElementById("editarproformaModal");

        if (event.target === createModal) {
            closeModal();
        } else if (event.target === editModal) {
            closeModal();
        }
      });
    </script>
  </body>
</html>

{% endblock content %}
